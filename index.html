<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SJS Manager - Enterprise Cloud Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sjs-manager-enterprise';

        let sales = [];
        let purchases = [];
        let expenses = [];
        let personal = []; // New state for personal expenses
        let currentPeriod = 'month';
        let currentUser = null;
        let searchQuery = "";

        const showToast = (msg, type = 'info') => {
            const toast = document.getElementById('toast');
            const bg = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600';
            toast.className = `fixed bottom-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white font-bold shadow-2xl transition-all opacity-100 z-[100] ${bg}`;
            toast.innerText = msg;
            setTimeout(() => { toast.classList.add('opacity-0'); }, 3000);
        };

        const toggleLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        const initAuth = async () => {
            toggleLoading(true);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                showToast("Connection failed", "error");
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) setupRealtimeListeners();
            toggleLoading(false);
        });

        const setupRealtimeListeners = () => {
            if (!currentUser) return;
            const collections = ['sales', 'purchases', 'expenses', 'personal'];
            collections.forEach(path => {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', path), (snap) => {
                    const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                    if(path === 'sales') { sales = data; renderSales(); }
                    if(path === 'purchases') { purchases = data; renderPurchases(); }
                    if(path === 'expenses') { expenses = data; renderExpenses(); }
                    if(path === 'personal') { personal = data; renderPersonal(); }
                    generateReport();
                    renderHistoryList();
                });
            });
        };

        const setDefaultDates = () => {
            const today = new Date().toISOString().split('T')[0];
            ['saleDate', 'purchDate', 'expDate', 'persDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = today;
            });
        };

        window.settleUdhaar = async (coll, id, type) => {
            const res = confirm("Payment ho gayi?\n\nOK = Cash\nCancel = Bank (UPI)");
            const paymentMethod = res ? 'Cash' : 'UPI';
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id), {
                    mode: paymentMethod, settledAt: Date.now(), wasUdhaar: true
                });
                showToast(`Hisaab Clear!`, "success");
            } catch (e) { showToast("Update fail ho gaya", "error"); }
        };

        window.handleSearch = (val) => {
            searchQuery = val.toLowerCase().trim();
            renderSales(); renderPurchases(); renderExpenses(); renderPersonal();
            generateReport(); renderHistoryList();
        };

        // Actions
        window.addSale = async () => {
            const item = document.getElementById('saleItem').value;
            const amount = parseFloat(document.getElementById('saleAmount').value);
            const mode = document.getElementById('saleMode').value;
            const customer = document.getElementById('saleCustomer').value || 'Walk-in';
            const entryDate = document.getElementById('saleDate').value;
            if (!item || isNaN(amount)) return showToast("Details bharein", "error");
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sales', Date.now().toString()), {
                item, amount, mode, customer, timestamp: Date.now(), date: new Date(entryDate).toISOString()
            });
            document.getElementById('saleItem').value = ''; document.getElementById('saleAmount').value = '';
            showToast("Sale Saved", "success");
        };

        window.addPurchase = async () => {
            const supplier = document.getElementById('purchSupplier').value;
            const amount = parseFloat(document.getElementById('purchAmount').value);
            const mode = document.getElementById('purchMode').value;
            const entryDate = document.getElementById('purchDate').value;
            if (!supplier || isNaN(amount)) return showToast("Details bharein", "error");
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'purchases', Date.now().toString()), {
                supplier, amount, mode, timestamp: Date.now(), date: new Date(entryDate).toISOString()
            });
            document.getElementById('purchSupplier').value = ''; document.getElementById('purchAmount').value = '';
            showToast("Purchase Saved", "success");
        };

        window.addExpense = async () => {
            const reason = document.getElementById('expReason').value;
            const amount = parseFloat(document.getElementById('expAmount').value);
            const mode = document.getElementById('expMode').value;
            const entryDate = document.getElementById('expDate').value;
            if (!reason || isNaN(amount)) return showToast("Details bharein", "error");
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', Date.now().toString()), {
                reason, amount, mode, timestamp: Date.now(), date: new Date(entryDate).toISOString()
            });
            document.getElementById('expReason').value = ''; document.getElementById('expAmount').value = '';
            showToast("Expense Saved", "success");
        };

        window.addPersonal = async () => {
            const reason = document.getElementById('persReason').value;
            const amount = parseFloat(document.getElementById('persAmount').value);
            const mode = document.getElementById('persMode').value;
            const entryDate = document.getElementById('persDate').value;
            if (!reason || isNaN(amount)) return showToast("Details bharein", "error");
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'personal', Date.now().toString()), {
                reason, amount, mode, timestamp: Date.now(), date: new Date(entryDate).toISOString()
            });
            document.getElementById('persReason').value = ''; document.getElementById('persAmount').value = '';
            showToast("Personal Expense Saved", "success");
        };

        window.deleteEntry = async (collectionName, id) => {
            if(!confirm("Pakka delete karna hai?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id));
            showToast("Uda diya gaya.");
        };

        // UI Renders
        const renderSales = () => {
            const tbody = document.getElementById('salesTableBody');
            const filtered = sales.filter(s => (s.item || "").toLowerCase().includes(searchQuery) || (s.customer || "").toLowerCase().includes(searchQuery));
            document.getElementById('todayTotal').innerText = sales.filter(s => new Date(s.date).toDateString() === new Date().toDateString() && s.mode !== 'Udhaar').reduce((a,b)=>a+b.amount,0).toLocaleString('en-IN');
            tbody.innerHTML = filtered.slice(0, 10).map(s => `
                <tr class="border-b">
                    <td class="px-4 py-3"><div class="font-bold">${s.item}</div><div class="text-[10px] text-gray-400">${s.customer} ‚Ä¢ ${new Date(s.date).toLocaleDateString()}</div></td>
                    <td class="px-2 py-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${s.mode==='Cash'?'bg-green-100 text-green-700':s.mode==='UPI'?'bg-blue-100 text-blue-700':'bg-amber-100 text-amber-700'}">${s.mode}</span></td>
                    <td class="px-4 py-3 text-right font-bold">‚Çπ${s.amount}</td>
                    <td class="px-2 py-3 text-center"><button onclick="deleteEntry('sales','${s.id}')" class="text-red-300">‚úï</button></td>
                </tr>`).join('');
        };

        const renderPurchases = () => {
            const filtered = purchases.filter(p => (p.supplier || "").toLowerCase().includes(searchQuery));
            document.getElementById('purchaseTableBody').innerHTML = filtered.slice(0, 10).map(p => `
                <tr class="border-b">
                    <td class="px-4 py-3"><div class="font-bold">${p.supplier}</div><div class="text-[10px] text-gray-400">${new Date(p.date).toLocaleDateString()}</div></td>
                    <td class="px-2 py-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${p.mode==='Cash'?'bg-green-100 text-green-700':p.mode==='UPI'?'bg-blue-100 text-blue-700':'bg-amber-100 text-amber-700'}">${p.mode}</span></td>
                    <td class="px-4 py-3 text-right font-bold">‚Çπ${p.amount}</td>
                    <td class="px-2 py-3 text-center"><button onclick="deleteEntry('purchases','${p.id}')" class="text-red-300">‚úï</button></td>
                </tr>`).join('');
        };

        const renderExpenses = () => {
            const filtered = expenses.filter(e => (e.reason || "").toLowerCase().includes(searchQuery));
            document.getElementById('expenseTableBody').innerHTML = filtered.slice(0, 10).map(e => `
                <tr class="border-b">
                    <td class="px-4 py-3"><div class="font-bold">${e.reason}</div><div class="text-[10px] text-gray-400">${new Date(e.date).toLocaleDateString()}</div></td>
                    <td class="px-2 py-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${e.mode==='Cash'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'}">${e.mode}</span></td>
                    <td class="px-4 py-3 text-right font-bold">‚Çπ${e.amount}</td>
                    <td class="px-2 py-3 text-center"><button onclick="deleteEntry('expenses','${e.id}')" class="text-red-300">‚úï</button></td>
                </tr>`).join('');
        };

        const renderPersonal = () => {
            const filtered = personal.filter(e => (e.reason || "").toLowerCase().includes(searchQuery));
            document.getElementById('personalTableBody').innerHTML = filtered.slice(0, 10).map(e => `
                <tr class="border-b">
                    <td class="px-4 py-3"><div class="font-bold">${e.reason}</div><div class="text-[10px] text-gray-400">${new Date(e.date).toLocaleDateString()}</div></td>
                    <td class="px-2 py-3"><span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${e.mode==='Cash'?'bg-green-100 text-green-700':'bg-blue-100 text-blue-700'}">${e.mode}</span></td>
                    <td class="px-4 py-3 text-right font-bold">‚Çπ${e.amount}</td>
                    <td class="px-2 py-3 text-center"><button onclick="deleteEntry('personal','${e.id}')" class="text-red-300">‚úï</button></td>
                </tr>`).join('');
        };

        const renderHistoryList = () => {
            const container = document.getElementById('fullHistoryList');
            const combined = [
                ...sales.map(s => ({ ...s, type: 'Bikri', name: s.customer })),
                ...purchases.map(p => ({ ...p, type: 'Purchase', name: p.supplier })),
                ...expenses.map(e => ({ ...e, type: 'Business Exp', name: e.reason })),
                ...personal.map(pers => ({ ...pers, type: 'Personal', name: pers.reason }))
            ].filter(item => (item.name || "").toLowerCase().includes(searchQuery))
             .sort((a, b) => new Date(b.date) - new Date(a.date));
            if (!combined.length) { container.innerHTML = `<div class="p-10 text-center text-gray-400">No records found.</div>`; return; }
            container.innerHTML = combined.slice(0, 50).map(item => `
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between mb-2">
                    <div class="flex flex-col">
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] font-black px-1.5 py-0.5 rounded ${item.type==='Bikri'?'bg-green-100 text-green-700':item.type==='Purchase'?'bg-blue-100 text-blue-700':item.type==='Personal'?'bg-orange-100 text-orange-700':'bg-red-100 text-red-700'} uppercase">${item.type}</span>
                            <span class="text-xs font-bold text-slate-800">${item.name}</span>
                        </div>
                        <div class="text-[10px] text-slate-400 mt-1">${new Date(item.date).toLocaleDateString()}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-black text-slate-900">‚Çπ${item.amount.toLocaleString('en-IN')}</div>
                        <div class="text-[8px] font-bold text-slate-400 uppercase">${item.mode}</div>
                    </div>
                </div>`).join('');
        };

        const generateReport = () => {
            const now = new Date();
            const todayStr = now.toDateString();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();

            const liveTodaySale = sales.filter(s => new Date(s.date).toDateString() === todayStr).reduce((a,b)=>a+b.amount,0);
            const liveMonthSale = sales.filter(s => {
                const d = new Date(s.date);
                return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
            }).reduce((a,b)=>a+b.amount,0);

            document.getElementById('liveTodayTotal').innerText = liveTodaySale.toLocaleString('en-IN');
            document.getElementById('liveMonthTotal').innerText = liveMonthSale.toLocaleString('en-IN');

            const filterByPeriod = (dStr) => {
                const d = new Date(dStr);
                if (currentPeriod === 'all') return true;
                if (currentPeriod === 'today') return d.toDateString() === todayStr;
                if (currentPeriod === 'month') return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
                return true;
            };

            const fSales = sales.filter(s => filterByPeriod(s.date));
            const fPurch = purchases.filter(p => filterByPeriod(p.date));
            const fExp = expenses.filter(e => filterByPeriod(e.date));
            const fPers = personal.filter(p => filterByPeriod(p.date));

            const sCash = fSales.filter(s => s.mode === 'Cash').reduce((a,b)=>a+b.amount,0);
            const sUPI = fSales.filter(s => s.mode === 'UPI').reduce((a,b)=>a+b.amount,0);
            const sUdhaar = fSales.filter(s => s.mode === 'Udhaar').reduce((a,b)=>a+b.amount,0);

            const pCash = fPurch.filter(p => p.mode === 'Cash').reduce((a,b)=>a+b.amount,0);
            const pUPI = fPurch.filter(p => p.mode === 'UPI').reduce((a,b)=>a+b.amount,0);
            const pUdhaar = fPurch.filter(p => p.mode === 'Udhaar').reduce((a,b)=>a+b.amount,0);

            const eCash = fExp.filter(e => e.mode === 'Cash').reduce((a,b)=>a+b.amount,0);
            const eUPI = fExp.filter(e => e.mode === 'UPI').reduce((a,b)=>a+b.amount,0);

            const persCash = fPers.filter(p => p.mode === 'Cash').reduce((a,b)=>a+b.amount,0);
            const persUPI = fPers.filter(p => p.mode === 'UPI').reduce((a,b)=>a+b.amount,0);

            // Galla (Real Balance)
            document.getElementById('rptCashHand').innerText = (sCash - pCash - eCash - persCash).toLocaleString('en-IN');
            document.getElementById('rptBank').innerText = (sUPI - pUPI - eUPI - persUPI).toLocaleString('en-IN');
            document.getElementById('rptLenaUdhaar').innerText = sUdhaar.toLocaleString('en-IN');
            document.getElementById('rptDenaUdhaar').innerText = pUdhaar.toLocaleString('en-IN');
            
            // Business Logic: Profit = Sales - Purchases - Business Expenses
            const totalRevenue = fSales.reduce((a,b)=>a+b.amount,0);
            const totalStockCost = fPurch.reduce((a,b)=>a+b.amount,0);
            const totalBizExp = fExp.reduce((a,b)=>a+b.amount,0);
            const netProfit = totalRevenue - totalStockCost - totalBizExp;

            document.getElementById('rptNetProfit').innerText = netProfit.toLocaleString('en-IN');
            document.getElementById('rptPersonalTotal').innerText = fPers.reduce((a,b)=>a+b.amount,0).toLocaleString('en-IN');

            const udhaarList = document.getElementById('udhaarDetailList');
            udhaarList.innerHTML = '';
            fSales.filter(s => s.mode === 'Udhaar').forEach(c => {
                udhaarList.innerHTML += `<div class="flex items-center justify-between border-b py-3 text-sm"><div><div class="font-bold">${c.customer}</div><div class="text-[10px] text-gray-400">${c.item}</div></div><div class="flex items-center gap-2"><span>‚Çπ${c.amount}</span><button onclick="settleUdhaar('sales','${c.id}','sale')" class="bg-green-600 text-white text-[9px] px-2 py-1 rounded">Clear</button></div></div>`;
            });
            fPurch.filter(p => p.mode === 'Udhaar').forEach(s => {
                udhaarList.innerHTML += `<div class="flex items-center justify-between border-b py-3 text-sm"><div><div class="font-bold">${s.supplier}</div><div class="text-[10px] text-gray-400">Stock</div></div><div class="flex items-center gap-2"><span class="text-red-600">‚Çπ${s.amount}</span><button onclick="settleUdhaar('purchases','${s.id}','purch')" class="bg-red-500 text-white text-[9px] px-2 py-1 rounded">Pay</button></div></div>`;
            });
        };

        window.downloadFullHistory = (months) => {
            const monthsBack = parseInt(months);
            const cutoff = new Date(); cutoff.setMonth(cutoff.getMonth() - monthsBack);
            const filter = (item) => new Date(item.date) >= cutoff;
            let csv = "DATE,TYPE,NAME,ITEM/REASON,AMOUNT,MODE,WAS_UDHAAR\n";
            const all = [
                ...sales.filter(filter).map(s => `"${new Date(s.date).toISOString().split('T')[0]}",SALE,"${s.customer}","${s.item}",${s.amount},"${s.mode}","${s.wasUdhaar ? 'YES' : 'NO'}"`),
                ...purchases.filter(filter).map(p => `"${new Date(p.date).toISOString().split('T')[0]}",PURCHASE,"${p.supplier}","-",${p.amount},"${p.mode}","${p.wasUdhaar ? 'YES' : 'NO'}"`),
                ...expenses.filter(filter).map(e => `"${new Date(e.date).toISOString().split('T')[0]}",BUSINESS_EXPENSE,"-","${e.reason}",${e.amount},"${e.mode}","-"`),
                ...personal.filter(filter).map(e => `"${new Date(e.date).toISOString().split('T')[0]}",PERSONAL_KHARCHA,"-","${e.reason}",${e.amount},"${e.mode}","-"`)
            ];
            csv += all.join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = window.URL.createObjectURL(blob);
            link.download = `SJS_Report_${months}Mo.csv`;
            link.click();
            showToast(`${months} Mahine ka data download hua.`);
        };

        window.setReportPeriod = (p) => { 
            currentPeriod = p; 
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('bg-green-700','text-white'));
            document.getElementById('btn-'+p).classList.add('bg-green-700','text-white');
            generateReport(); 
        };
        
        window.showTab = (t) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active','bg-green-800'));
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-'+t).classList.add('active','bg-green-800');
            if(t === 'report') generateReport();
            if(t === 'history') renderHistoryList();
        };

        window.attemptLogin = () => {
            if(document.getElementById('loginPass').value.toLowerCase() === 'niku9828') {
                document.getElementById('loginOverlay').classList.add('hidden');
                sessionStorage.setItem('isLoggedIn', 'true');
                setDefaultDates();
            }
        };

        initAuth();
        window.onload = setDefaultDates;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .tab-btn.active { border-bottom: 3px solid #facc15; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select { font-size: 16px !important; }
        .transition-all { transition: all 0.2s ease; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-slate-800">

    <div id="toast" class="fixed opacity-0 pointer-events-none transition-all"></div>
    <div id="loadingOverlay" class="fixed inset-0 bg-white/95 z-[60] flex items-center justify-center backdrop-blur-md">
        <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-4 border-green-600 border-t-transparent mx-auto mb-3"></div>
            <p class="text-[10px] font-black uppercase tracking-widest text-green-700">Syncing Cloud...</p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="loginOverlay" class="fixed inset-0 bg-green-950 flex flex-col items-center justify-center z-50 px-4">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-black mb-6 italic uppercase tracking-tighter">SJS Selection</h2>
            <input type="password" id="loginPass" class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-4 text-center text-xl outline-none" placeholder="PIN">
            <button onclick="attemptLogin()" class="w-full bg-green-700 text-white font-black py-4 rounded-2xl shadow-xl">UNLOCK</button>
        </div>
    </div>

    <!-- HEADER -->
    <header class="bg-green-700 text-white shrink-0 shadow-xl z-10">
        <div class="px-5 py-3 flex justify-between items-center">
            <span class="font-black text-lg italic uppercase tracking-tighter">SJS Selection</span>
            <button onclick="sessionStorage.clear(); location.reload();" class="text-[8px] font-black border border-white/20 px-3 py-1 rounded-full uppercase">Logout</button>
        </div>
        <div class="flex overflow-x-auto no-scrollbar px-1 bg-green-700">
            <button onclick="showTab('sell')" id="tab-sell" class="tab-btn active flex-1 py-3 text-[8px] font-black min-w-[65px]">SALES</button>
            <button onclick="showTab('purchase')" id="tab-purchase" class="tab-btn flex-1 py-3 text-[8px] font-black min-w-[65px]">PURCHASE</button>
            <button onclick="showTab('expense')" id="tab-expense" class="tab-btn flex-1 py-3 text-[8px] font-black min-w-[65px]">BUSINESS</button>
            <button onclick="showTab('personal')" id="tab-personal" class="tab-btn flex-1 py-3 text-[8px] font-black min-w-[65px]">PERSONAL</button>
            <button onclick="showTab('history')" id="tab-history" class="tab-btn flex-1 py-3 text-[8px] font-black min-w-[65px]">HISTORY</button>
            <button onclick="showTab('report')" id="tab-report" class="tab-btn flex-1 py-3 text-[8px] font-black min-w-[65px] border-l border-white/10">REPORT</button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 bg-slate-100">
        <div class="max-w-4xl mx-auto pb-16">

            <!-- SALES -->
            <div id="view-sell" class="tab-content space-y-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border space-y-3">
                    <input type="date" id="saleDate" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <input type="text" id="saleItem" placeholder="Maal Ka Naam" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="saleAmount" placeholder="Price ‚Çπ" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                        <select id="saleMode" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 font-bold">
                            <option value="Cash">Cash</option><option value="UPI">Bank/UPI</option><option value="Udhaar">Udhaar</option>
                        </select>
                    </div>
                    <input type="text" id="saleCustomer" placeholder="Customer Name" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <button onclick="addSale()" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl shadow-xl">RECORD SALE</button>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-slate-50/50">
                        <span class="text-[9px] font-black text-slate-400 uppercase">Today Cash</span>
                        <span class="text-xl font-black text-green-700">‚Çπ<span id="todayTotal">0</span></span>
                    </div>
                    <table class="w-full text-xs text-left"><tbody id="salesTableBody" class="divide-y"></tbody></table>
                </div>
            </div>

            <!-- PURCHASE -->
            <div id="view-purchase" class="tab-content hidden space-y-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border space-y-3">
                    <input type="date" id="purchDate" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <input type="text" id="purchSupplier" placeholder="Supplier / Party" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="purchAmount" placeholder="Amount ‚Çπ" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                        <select id="purchMode" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 font-bold">
                            <option value="Cash">Cash</option><option value="UPI">UPI</option><option value="Udhaar">Udhaar (Dena)</option>
                        </select>
                    </div>
                    <button onclick="addPurchase()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-xl">LOG PURCHASE</button>
                </div>
                <table class="w-full text-xs text-left bg-white rounded-3xl overflow-hidden shadow-sm"><tbody id="purchaseTableBody" class="divide-y"></tbody></table>
            </div>

            <!-- BUSINESS EXPENSES -->
            <div id="view-expense" class="tab-content hidden space-y-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border space-y-3">
                    <input type="date" id="expDate" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <input type="text" id="expReason" placeholder="Biz Reason (Rent, Bill, Tea)" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="expAmount" placeholder="Amount ‚Çπ" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                        <select id="expMode" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 font-bold">
                            <option value="Cash">Cash</option><option value="UPI">UPI</option>
                        </select>
                    </div>
                    <button onclick="addExpense()" class="w-full bg-red-600 text-white font-black py-4 rounded-2xl shadow-xl">SAVE BIZ EXPENSE</button>
                </div>
                <table class="w-full text-xs text-left bg-white rounded-3xl overflow-hidden shadow-sm"><tbody id="expenseTableBody" class="divide-y"></tbody></table>
            </div>

            <!-- PERSONAL EXPENSES (NEW) -->
            <div id="view-personal" class="tab-content hidden space-y-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-orange-100 space-y-3">
                    <h2 class="text-[10px] font-black text-orange-600 uppercase tracking-widest ml-1">Personal / Ghar Ka Kharcha</h2>
                    <input type="date" id="persDate" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <input type="text" id="persReason" placeholder="Reason (Ghar ka ration, Mobile recharge)" class="w-full p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="persAmount" placeholder="Amount ‚Çπ" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200">
                        <select id="persMode" class="p-3.5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-200 font-bold">
                            <option value="Cash">Galle Se (Cash)</option><option value="UPI">Bank Se (UPI)</option>
                        </select>
                    </div>
                    <button onclick="addPersonal()" class="w-full bg-orange-600 text-white font-black py-4 rounded-2xl shadow-xl">SAVE PERSONAL</button>
                </div>
                <table class="w-full text-xs text-left bg-white rounded-3xl overflow-hidden shadow-sm"><tbody id="personalTableBody" class="divide-y"></tbody></table>
            </div>

            <!-- HISTORY -->
            <div id="view-history" class="tab-content hidden space-y-4">
                <input type="text" oninput="handleSearch(this.value)" placeholder="Search history..." class="w-full p-4 bg-white rounded-2xl border-none shadow-sm text-xs">
                <div id="fullHistoryList" class="space-y-2"></div>
            </div>

            <!-- REPORT -->
            <div id="view-report" class="tab-content hidden space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-5 rounded-[2rem] border-2 border-green-500 shadow-md">
                        <p class="text-[10px] font-black text-green-600 uppercase mb-1 tracking-tighter">Live Today Sale</p>
                        <h3 class="text-2xl font-black">‚Çπ<span id="liveTodayTotal">0</span></h3>
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border-2 border-blue-500 shadow-md">
                        <p class="text-[10px] font-black text-blue-600 uppercase mb-1 tracking-tighter">Live Month Sale</p>
                        <h3 class="text-2xl font-black">‚Çπ<span id="liveMonthTotal">0</span></h3>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border">
                    <!-- Net Profit Card (NEW) -->
                    <div class="bg-slate-900 text-white p-6 rounded-[2rem] shadow-xl mb-6 text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">Business Net Profit üí∞</p>
                        <h2 class="text-4xl font-black italic">‚Çπ<span id="rptNetProfit">0</span></h2>
                        <p class="text-[8px] text-slate-500 mt-2 italic font-bold">Calculation: Sales - Purchase - Business Expenses</p>
                    </div>

                    <div class="flex gap-2 mb-6 overflow-x-auto no-scrollbar">
                        <button id="btn-today" onclick="setReportPeriod('today')" class="period-btn px-6 py-2 rounded-full text-[9px] font-black bg-slate-100 text-slate-500">Today</button>
                        <button id="btn-month" onclick="setReportPeriod('month')" class="period-btn active px-6 py-2 rounded-full text-[9px] font-black bg-green-700 text-white">This Month</button>
                        <button id="btn-all" onclick="setReportPeriod('all')" class="period-btn px-6 py-2 rounded-full text-[9px] font-black bg-slate-100 text-slate-500">All History</button>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-green-50 p-5 rounded-3xl border border-green-100">
                            <p class="text-[9px] font-black text-green-600 uppercase">Cash (Galla)</p>
                            <h3 class="text-lg font-black">‚Çπ<span id="rptCashHand">0</span></h3>
                        </div>
                        <div class="bg-blue-50 p-5 rounded-3xl border border-blue-100">
                            <p class="text-[9px] font-black text-blue-600 uppercase">Bank (UPI)</p>
                            <h3 class="text-lg font-black">‚Çπ<span id="rptBank">0</span></h3>
                        </div>
                        <div class="bg-amber-50 p-5 rounded-3xl border border-amber-100">
                            <p class="text-[9px] font-black text-amber-600 uppercase tracking-tighter">Lena (Udhaar)</p>
                            <h3 class="text-lg font-black">‚Çπ<span id="rptLenaUdhaar">0</span></h3>
                        </div>
                        <div class="bg-red-50 p-5 rounded-3xl border border-red-100">
                            <p class="text-[9px] font-black text-red-600 uppercase tracking-tighter">Dena (Udhaar)</p>
                            <h3 class="text-lg font-black">‚Çπ<span id="rptDenaUdhaar">0</span></h3>
                        </div>
                    </div>

                    <!-- Personal Kharcha Stats (NEW) -->
                    <div class="bg-orange-50 p-5 rounded-[2rem] border-2 border-orange-100 mb-6 flex justify-between items-center">
                        <div>
                            <p class="text-[9px] font-black text-orange-600 uppercase mb-1">Personal / Ghar Use</p>
                            <h3 class="text-xl font-black">‚Çπ<span id="rptPersonalTotal">0</span></h3>
                        </div>
                        <span class="text-3xl grayscale opacity-30">üè†</span>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-[2rem] border">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest italic">Udhaar List</h2>
                        <div id="udhaarDetailList" class="space-y-1"></div>
                    </div>

                    <div class="mt-6">
                        <select id="historyPeriod" class="w-full p-4 bg-slate-50 border rounded-2xl text-xs font-bold mb-2">
                            <option value="1">Download Last 1 Month CSV</option>
                            <option value="12">Download Last 12 Months CSV</option>
                        </select>
                        <button onclick="downloadFullHistory(document.getElementById('historyPeriod').value)" class="w-full bg-slate-800 text-white p-4 rounded-2xl font-black text-xs">GET DATA FOR CA</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="p-4 text-center text-[8px] text-gray-400 uppercase tracking-[0.4em] bg-white border-t">
        Cloud Enterprise Sync ‚Ä¢ Multi-Million Record Storage Active
    </footer>

</body>
</html>
